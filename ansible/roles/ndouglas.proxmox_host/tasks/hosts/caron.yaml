- name: 'Reconfigure the application.'
  remote_user: 'root'
  block:

    - name: 'Preseed inithooks.'
      ansible.builtin.copy:
        dest: '/etc/inithooks.conf'
        content: |
          # Specific
          export ADMIN_PASS={{ password }}
          export ADMIN_EMAIL={{ hostname }}@{{ domains.private }}
          # Generic
          export ROOT_PASS={{ password }}
          export DB_PASS={{ password }}
          export APP_EMAIL={{ hostname }}@{{ domains.private }}
          export APP_PASS={{ password }}
          export SEC_ALERTS={{ hostname }}@{{ domains.private }}
          export SEC_UPDATES=FORCE
          export HUB_APIKEY={{ turnkey.api_key }}

    - name: 'Reinitialize the application.'
      ansible.builtin.command:
        cmd: |
          turnkey-init

- name: 'Add the backup job to cron.'
  remote_user: 'root'
  block:

    - name: 'Set the email address appropriately for cron jobs.'
      ansible.builtin.cron:
        name: MAILTO
        env: yes
        job: "{{ hostname }}@{{ domains.private }}"

    - name: 'Install the update cronjob.'
      ansible.builtin.cron:
        name: 'update-dotfiles'
        minute: "{{ 60 | random(seed=user_at_hostname) }}"
        job: |
          /bin/bash -lc 'tklbam-backup'
