---
- name: 'Set some important facts...'
  ansible.builtin.set_fact:
    torrents_root_path: '/torrents'
    user: "{{ my.name.lower }}"
    group: "{{ my.name.lower }}"

- name: 'Set some basic facts...'
  ansible.builtin.include_role:
    name: 'ndouglas.deploy_dotfiles'
    tasks_from: 'set_common_facts.yaml'

- name: 'Set some useful facts.'
  ansible.builtin.set_fact:
    instance_storage_path: "{{ torrents_root_path }}/{{ instance_id }}"
    transmission_peer_port: "{{ base_port + instance_id }}"

- name: 'Create instance root directory.'
  ansible.builtin.file:
    path: "{{ instance_storage_path }}"
    state: 'directory'
    mode: '0755'
    owner: "{{ user }}"
    group: "{{ group }}"

- name: 'Create symlink pointing to instance ID from domain.'
  ansible.builtin.file:
    path: "{{ torrents_root_path }}/{{ instance_domain }}"
    src: "{{ instance_storage_path }}"
    state: 'link'

- name: 'Prepare directory structure.'
  ansible.builtin.file:
    path: "{{ instance_storage_path }}/{{ item }}"
    state: 'directory'
    mode: '0755'
  loop:
    - "config"
    - "watch"
    - "incomplete"
    - "downloaded"

- name: "Copy Transmission template files {{ role_path }}/files/config/ -> {{ instance_storage_path }}/config/."
  ansible.builtin.template:
    src: "{{ item }}"
    dest: "{{ instance_storage_path }}/config/{{ item | basename | splitext | first }}"
    mode: '0755'
  with_fileglob:
    - "{{ role_path }}/files/config/*.j2"
