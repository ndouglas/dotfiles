---
- name: 'Add Argo chart repository.'
  kubernetes.core.helm_repository:
    name: 'argo'
    repo_url: 'https://argoproj.github.io/argo-helm'

- name: 'Deploy Argo CD.'
  kubernetes.core.helm:
    name: 'argocd'
    chart_ref: 'argo/argo-cd'
    release_namespace: 'argocd'
    create_namespace: yes
    values:
      secret:
        createSecret: yes
        argocdServerAdminPassword: "{{ password | password_hash('bcrypt') }}"
      server:
        service:
          type: 'ClusterIP'
        extraArgs:
          - '--insecure'

- name: 'Argo CD Server ingress.'
  kubernetes.core.k8s:
    kubeconfig: '~/.kube/config'
    namespace: 'argocd'
    definition:
      apiVersion: 'networking.k8s.io/v1'
      kind: 'Ingress'
      metadata:
        name: 'argocd-server'
        annotations:
          cert-manager.io/cluster-issuer: 'letsencrypt-prod'
      spec:
        rules:
          - host: "argocd.{{ route53_personal_fqdn }}"
            http:
              paths:
                - pathType: 'Prefix'
                  path: '/'
                  backend:
                    service:
                      name: 'argocd-server'
                      port:
                        number: 80
          - host: "argocd.{{ route53_private_fqdn }}"
            http:
              paths:
                - pathType: 'Prefix'
                  path: '/'
                  backend:
                    service:
                      name: 'argocd-server'
                      port:
                        number: 80
        tls:
          - hosts:
              - "argocd.{{ route53_personal_fqdn }}"
              - "*.argocd.{{ route53_personal_fqdn }}"
            secretName: "argocd.{{ route53_personal_fqdn }}-certificate"
          - hosts:
              - "argocd.{{ route53_private_fqdn }}"
              - "*.argocd.{{ route53_private_fqdn }}"
            secretName: "argocd.{{ route53_private_fqdn }}-certificate"

- name: 'Argo CD Server gRPC ingress.'
  kubernetes.core.k8s:
    kubeconfig: '~/.kube/config'
    namespace: 'argocd'
    definition:
      apiVersion: 'networking.k8s.io/v1'
      kind: 'Ingress'
      metadata:
        name: 'argocd-serve-grpc'
        annotations:
          ingress.kubernetes.io/protocol: 'h2c'
      spec:
        rules:
          - host: "argocd-grpc.{{ route53_personal_fqdn }}"
            http:
              paths:
                - pathType: 'Prefix'
                  path: '/'
                  backend:
                    service:
                      name: 'argocd-server'
                      port:
                        number: 80
          - host: "argocd-grpc.{{ route53_private_fqdn }}"
            http:
              paths:
                - pathType: 'Prefix'
                  path: '/'
                  backend:
                    service:
                      name: 'argocd-server'
                      port:
                        number: 80
        tls:
          - hosts:
              - "argocd-grpc.{{ route53_personal_fqdn }}"
              - "*.argocd-grpc.{{ route53_personal_fqdn }}"
            secretName: 'argocd-secret'
          - hosts:
              - "argocd-grpc.{{ route53_private_fqdn }}"
              - "*.argocd-grpc.{{ route53_private_fqdn }}"
            secretName: 'argocd-secret'
