---
- name: 'Gather host facts.'
  ansible.builtin.include_role:
    name: 'ndouglas.proxmox_host'
    tasks_from: 'set_pve_host_facts.yaml'

- name: 'Create hosts.'
  ansible.builtin.include_role:
    name: 'ndouglas.proxmox_host'
    tasks_from: 'create_pve_host.yaml'
  when: no

- name: 'Setup hosts.'
  ansible.builtin.include_role:
    name: 'ndouglas.proxmox_host'
    tasks_from: 'setup_pve_host.yaml'
  when: no

- name: 'Switch back to a normal connection method.'
  ansible.builtin.set_fact:
    ansible_connection: 'ssh'

- name: 'Use the root user for the time being.'
  remote_user: 'root'
  block:

  - name: 'Setup Docker on hosts.'
    ansible.builtin.include_role:
      name: 'ndouglas.host_role.docker'
    when: no

  - name: 'Install packages and other requirements.'
    ansible.builtin.include_role:
      name: 'ndouglas.host_role.k8s'
    when: no

  - name: 'Copy configuration.'
    ansible.builtin.slurp:
      src: '/etc/kubernetes/kubelet.conf'
    register: 'kube_config'

  - name: 'Write kube config.'
    ansible.builtin.copy:
      content: "{{ kube_config['content'] | b64decode }}"
      dest: '~/.kube/config'
